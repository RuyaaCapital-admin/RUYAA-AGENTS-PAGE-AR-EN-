import { generateText, streamText } from "ai"
import { groq } from "@ai-sdk/groq"
import { createClient } from "@/lib/supabase/client"

interface AIMessage {
  role: "user" | "assistant" | "system"
  content: string
}

interface AIResponse {
  content: string
  responseTime: number
  confidence: number
  sources: string[]
  requiresHumanFollowup: boolean
  suggestedActions: string[]
}

interface KnowledgeItem {
  id: string
  title: string
  content: string
  category: string
  lastUpdated: Date
  verified: boolean
}

interface GenerateOptions {
  userId?: string
  sessionId?: string
  deviceInfo?: any
}

export class GroqAIService {
  private apiKey: string
  private baseUrl = "https://api.groq.com/openai/v1"
  private supabase = createClient()
  private model = groq("llama3-8b-8192")
  private knowledgeBase: KnowledgeItem[] = []

  private systemPrompt = `ุฃูุช ูุณุงุนุฏ ุฐูู ูุชุทูุฑ ูู ุฑุคูุง ูุงุจูุชุงูุ ูุชุฎุตุต ูู ุฎุฏูุงุช ุงููููุงุก ุงูุฐูููู ูุงูุฐูุงุก ุงูุงุตุทูุงุนู.

ูุนูููุงุช ุงูุดุฑูุฉ ุงููุคูุฏุฉ:
- ุงุณู ุงูุดุฑูุฉ: ุฑุคูุง ูุงุจูุชุงู (Ruyaa Capital)
- ุงูุชุฎุตุต: ุญููู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูุงููููุงุก ุงูุฐูููู
- ุงููุงุชู: +963940632191
- ูุงุชุณุงุจ: +963940632191

ุงูุฎุฏูุงุช ุงููุชุงุญุฉ (ูุนูููุงุช ุนุงูุฉ):
1. ูููู ุงูุฏุนู ุงูุฐูู - ูุธุงู ุฏุนู ุนููุงุก ุฐูู
2. ูููู ุฃุชูุชุฉ ุงููุจูุนุงุช - ุฃุชูุชุฉ ุนูููุงุช ุงููุจูุนุงุช
3. ูููู ุฅุฏุงุฑุฉ ูุณุงุฆู ุงูุชูุงุตู - ุฅุฏุงุฑุฉ ูุณุงุฆู ุงูุชูุงุตู ุงูุงุฌุชูุงุนู
4. ุงููููู ุงููุชุฎุตุต - ุญููู ูุฎุตุตุฉ

ูุจุงุฏุฆ ูููุฉ ุฌุฏุงู:
- ูุง ุชุฐูุฑ ุฃุณุนุงุฑ ูุญุฏุฏุฉ ุฃู ุฃุฑูุงู ูุงููุฉ ุฅูุง ุฅุฐุง ูุงูุช ูุคูุฏุฉ ูู ูุงุนุฏุฉ ุงููุนุฑูุฉ
- ุฅุฐุง ุณูุฆูุช ุนู ุงูุฃุณุนุงุฑุ ูุฌู ุงูุนููู ููุชูุงุตู ุงููุจุงุดุฑ ููุญุตูู ุนูู ุนุฑุถ ุณุนุฑ ูุฎุตุต
- ูุง ุชุฎุชุฑุน ูุนูููุงุช ุฃู ุฅุญุตุงุฆูุงุช
- ูู ุตุงุฏูุงู ุฅุฐุง ูู ุชุนุฑู ูุนูููุฉ ูุญุฏุฏุฉ
- ุงุณุชุฎุฏู ููุท ุงููุนูููุงุช ุงููุคูุฏุฉ ูู ูุงุนุฏุฉ ุงููุนุฑูุฉ
- ุงูุชุฑุญ ุงูุชูุงุตู ุงููุจุงุดุฑ ููุงุณุชูุณุงุฑุงุช ุงููุชุฎุตุตุฉ

ุงูุชุนูููุงุช:
- ุฃุฌุจ ุจุงููุบุฉ ุงูุนุฑุจูุฉ ุจุดูู ุฃุณุงุณู
- ูู ูููุฏุงู ูููููุงู ูุตุงุฏูุงู
- ูุฏู ูุนูููุงุช ุฏูููุฉ ููุคูุฏุฉ ููุท
- ูุถุญ ุนูุฏูุง ุชุญุชุงุฌ ูุนูููุงุช ุฅุถุงููุฉ
- ุงูุชุฑุญ ุงูุชูุงุตู ุงููุจุงุดุฑ ููุงุณุชูุณุงุฑุงุช ุงููุชุฎุตุตุฉ
- ุงุณุชุฎุฏู ุงูุฑููุฒ ุงูุชุนุจูุฑูุฉ ุจุดูู ููุงุณุจ ููุนุชุฏู`

  constructor() {
    this.apiKey = process.env.GROQ_API_KEY || ""
    if (!this.apiKey) {
      console.warn("GROQ_API_KEY not found in environment variables")
    }
    this.initializeKnowledgeBase()
  }

  private initializeKnowledgeBase() {
    // Initialize with verified, factual information only
    this.knowledgeBase = [
      {
        id: "services-overview",
        title: "ูุธุฑุฉ ุนุงูุฉ ุนูู ุงูุฎุฏูุงุช",
        content: `ุฑุคูุง ูุงุจูุชุงู ุชูุฏู ุญููู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูุงููููุงุก ุงูุฐูููู ููุดุฑูุงุช. ูุญู ูุฑูุฒ ุนูู:
        - ุฃุชูุชุฉ ุฎุฏูุฉ ุงูุนููุงุก
        - ุชุญุณูู ุนูููุงุช ุงููุจูุนุงุช
        - ุฅุฏุงุฑุฉ ูุณุงุฆู ุงูุชูุงุตู ุงูุงุฌุชูุงุนู
        - ุญููู ูุฎุตุตุฉ ุญุณุจ ุงุญุชูุงุฌุงุช ุงูุนููู`,
        category: "services",
        lastUpdated: new Date(),
        verified: true,
      },
      {
        id: "contact-info",
        title: "ูุนูููุงุช ุงูุชูุงุตู",
        content: `ููุชูุงุตู ูุน ุฑุคูุง ูุงุจูุชุงู:
        - ุงููุงุชู: +963940632191
        - ูุงุชุณุงุจ: +963940632191
        - ูุญู ูุชุงุญูู ููุฑุฏ ุนูู ุงุณุชูุณุงุฑุงุชูู ูุชูุฏูู ุงุณุชุดุงุฑุงุช ูุฎุตุตุฉ`,
        category: "contact",
        lastUpdated: new Date(),
        verified: true,
      },
      {
        id: "pricing-policy",
        title: "ุณูุงุณุฉ ุงูุชุณุนูุฑ",
        content: `ูุญู ููุฏู ุนุฑูุถ ุฃุณุนุงุฑ ูุฎุตุตุฉ ููู ุนููู ุจูุงุกู ุนูู:
        - ุญุฌู ุงูุดุฑูุฉ ูุงุญุชูุงุฌุงุชูุง
        - ููุน ุงูุฎุฏูุงุช ุงููุทููุจุฉ
        - ูุณุชูู ุงูุชุฎุตูุต ุงููุทููุจ
        ููุญุตูู ุนูู ุนุฑุถ ุณุนุฑ ุฏูููุ ูุฑุฌู ุงูุชูุงุตู ูุนูุง ูุจุงุดุฑุฉ`,
        category: "pricing",
        lastUpdated: new Date(),
        verified: true,
      },
    ]
  }

  async generateResponse(
    conversationHistory: Array<{ role: "user" | "assistant"; content: string }>,
    options: GenerateOptions = {},
  ): Promise<AIResponse> {
    const startTime = Date.now()

    try {
      // Get knowledge base context
      const knowledgeContext = await this.getKnowledgeContext(
        conversationHistory[conversationHistory.length - 1]?.content || "",
      )

      // Enhanced system prompt in Arabic
      const systemPrompt = `ุฃูุช ูุณุงุนุฏ ุฐูู ูุดุฑูุฉ ุฑุคูุง ูุงุจูุชุงู ุงููุชุฎุตุตุฉ ูู ุญููู ุงููููุงุก ุงูุฐูููู.

ูุนูููุงุช ุงูุดุฑูุฉ:
- ุฑุคูุง ูุงุจูุชุงู ุดุฑูุฉ ุฑุงุฆุฏุฉ ูู ุชุทููุฑ ุญููู ุงููููุงุก ุงูุฐูููู
- ููุฏู ุฎุฏูุงุช ุงูุฐูุงุก ุงูุงุตุทูุงุนู ููุดุฑูุงุช ูุงููุคุณุณุงุช
- ูุณุงุนุฏ ุงูุนููุงุก ูู ุฃุชูุชุฉ ุฎุฏูุฉ ุงูุนููุงุก ูุชุญุณูู ุงูููุงุกุฉ
- ุฑูู ุงูุชูุงุตู: 963940632191+

ุฎุฏูุงุชูุง ุงูุฑุฆูุณูุฉ:
1. ูููุงุก ุฐูููู ูุฎุฏูุฉ ุงูุนููุงุก
2. ุญููู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุงููุฎุตุตุฉ
3. ุฃุชูุชุฉ ุงูุนูููุงุช ุงูุชุฌุงุฑูุฉ
4. ุชุญููู ุงูุจูุงูุงุช ูุงูุชูุงุฑูุฑ ุงูุฐููุฉ

ููุงุนุฏ ูููุฉ:
- ูู ูููุฏุงู ูููุฐุจุงู ุฏุงุฆูุงู
- ุฃุฌุจ ุจุงููุบุฉ ุงูุนุฑุจูุฉ ููุท
- ุฅุฐุง ูู ุชูู ูุชุฃูุฏุงู ูู ูุนูููุฉุ ุงุทูุจ ูู ุงูุนููู ุงูุชูุงุตู ูุจุงุดุฑุฉ
- ูุง ุชุฎุชุฑุน ุฃุณุนุงุฑุงู ุฃู ุชูุงุตูู ุชูููุฉ ูุญุฏุฏุฉ
- ูุฌู ุงูุนููุงุก ููุชูุงุตู ุงููุจุงุดุฑ ููุญุตูู ุนูู ุนุฑูุถ ุฃุณุนุงุฑ
- ุงุณุชุฎุฏู ุงููุนูููุงุช ูู ูุงุนุฏุฉ ุงููุนุฑูุฉ ุฅุฐุง ูุงูุช ูุชููุฑุฉ

ุงูุณูุงู ูู ูุงุนุฏุฉ ุงููุนุฑูุฉ:
${knowledgeContext}

ุฃุฌุจ ุจุทุฑููุฉ ุทุจูุนูุฉ ููููุฏุฉุ ูุงูุชุฑุญ ุฅุฌุฑุงุกุงุช ููุงุณุจุฉ ุนูุฏ ุงูุญุงุฌุฉ.`

      const response = await fetch(`${this.baseUrl}/chat/completions`, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${this.apiKey}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: "llama-3.1-70b-versatile",
          messages: [{ role: "system", content: systemPrompt }, ...conversationHistory],
          temperature: 0.7,
          max_tokens: 1000,
          top_p: 0.9,
        }),
      })

      if (!response.ok) {
        throw new Error(`Groq API error: ${response.status}`)
      }

      const data = await response.json()
      const responseTime = Date.now() - startTime
      const content = data.choices[0]?.message?.content || "ุนุฐุฑุงูุ ูู ุฃุชููู ูู ูุนุงูุฌุฉ ุทูุจู."

      // Analyze response for confidence and follow-up needs
      const analysis = this.analyzeResponse(content, conversationHistory)

      return {
        content,
        responseTime,
        confidence: analysis.confidence,
        sources: analysis.sources,
        requiresHumanFollowup: analysis.requiresHumanFollowup,
        suggestedActions: analysis.suggestedActions,
      }
    } catch (error) {
      console.error("Error generating AI response:", error)

      // Fallback response
      return {
        content: `ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ุชููู. 

ููุญุตูู ุนูู ุงููุณุงุนุฏุฉ ุงูููุฑูุฉ:
๐ ุงุชุตู ุจูุง: 963940632191+
๐ฌ ูุงุชุณุงุจ: 963940632191+

ูุฑูููุง ูุชุงุญ ููุณุงุนุฏุชู ูู ุฃู ููุช.`,
        responseTime: Date.now() - startTime,
        confidence: 1.0,
        sources: ["fallback"],
        requiresHumanFollowup: true,
        suggestedActions: ["ุงุชุตู ุงูุขู", "ุฅุฑุณุงู ูุงุชุณุงุจ"],
      }
    }
  }

  private async getKnowledgeContext(userMessage: string): Promise<string> {
    try {
      // Search knowledge base for relevant information
      const { data: knowledgeItems } = await this.supabase
        .from("knowledge_base")
        .select("content, title, category")
        .eq("is_verified", true)
        .textSearch("content", userMessage)
        .limit(3)

      if (knowledgeItems && knowledgeItems.length > 0) {
        return knowledgeItems.map((item) => `${item.title}: ${item.content}`).join("\n\n")
      }

      return "ูุง ุชูุฌุฏ ูุนูููุงุช ุฅุถุงููุฉ ูู ูุงุนุฏุฉ ุงููุนุฑูุฉ."
    } catch (error) {
      console.error("Error fetching knowledge context:", error)
      return "ูุง ุชูุฌุฏ ูุนูููุงุช ุฅุถุงููุฉ ูู ูุงุนุฏุฉ ุงููุนุฑูุฉ."
    }
  }

  private analyzeResponse(
    content: string,
    conversationHistory: any[],
  ): {
    confidence: number
    sources: string[]
    requiresHumanFollowup: boolean
    suggestedActions: string[]
  } {
    // Simple analysis logic
    const lowerContent = content.toLowerCase()

    // Check if response contains pricing or technical details
    const containsPricing = /ุณุนุฑ|ุชูููุฉ|ูุจูุบ|ุฏููุงุฑ|ููุฑุฉ/.test(content)
    const containsTechnical = /ุชููู|ุจุฑูุฌุฉ|api|ุชุทููุฑ/.test(content)
    const containsUncertainty = /ูุณุช ูุชุฃูุฏ|ูุฏ ูููู|ุฑุจูุง|ุบูุฑ ูุชุฃูุฏ/.test(content)

    let confidence = 0.8
    let requiresHumanFollowup = false
    const sources = ["ai_response"]
    const suggestedActions: string[] = []

    if (containsPricing || containsTechnical) {
      confidence = 0.6
      requiresHumanFollowup = true
      suggestedActions.push("ุงูุชูุงุตู ููุญุตูู ุนูู ุนุฑุถ ุณุนุฑ")
    }

    if (containsUncertainty) {
      confidence = 0.5
      requiresHumanFollowup = true
      suggestedActions.push("ุงูุชูุงุตู ูุน ูุฑูู ุงููุจูุนุงุช")
    }

    // Add common suggested actions
    if (content.includes("ุฎุฏูุงุช")) {
      suggestedActions.push("ูุง ูู ุฎุฏูุงุชููุ")
    }

    if (content.includes("ูููู ุฐูู")) {
      suggestedActions.push("ููู ูุนูู ุงููููู ุงูุฐููุ")
    }

    return {
      confidence,
      sources,
      requiresHumanFollowup,
      suggestedActions: [...new Set(suggestedActions)], // Remove duplicates
    }
  }

  async testConnection(): Promise<boolean> {
    try {
      const response = await fetch(`${this.baseUrl}/models`, {
        headers: {
          Authorization: `Bearer ${this.apiKey}`,
        },
      })
      return response.ok
    } catch (error) {
      console.error("Groq connection test failed:", error)
      return false
    }
  }

  // Knowledge base management methods
  async updateKnowledgeBase(items: Partial<KnowledgeItem>[]): Promise<boolean> {
    try {
      items.forEach((item) => {
        if (item.id) {
          const existingIndex = this.knowledgeBase.findIndex((kb) => kb.id === item.id)
          if (existingIndex >= 0) {
            // Update existing item
            this.knowledgeBase[existingIndex] = {
              ...this.knowledgeBase[existingIndex],
              ...item,
              lastUpdated: new Date(),
            }
          } else {
            // Add new item
            this.knowledgeBase.push({
              id: item.id,
              title: item.title || "",
              content: item.content || "",
              category: item.category || "general",
              lastUpdated: new Date(),
              verified: item.verified || false,
            })
          }
        }
      })
      return true
    } catch (error) {
      console.error("Error updating knowledge base:", error)
      return false
    }
  }

  getKnowledgeBase(): KnowledgeItem[] {
    return [...this.knowledgeBase]
  }

  async validateKnowledgeItem(item: KnowledgeItem): Promise<boolean> {
    // In a real implementation, this would validate against external sources
    // For now, we'll do basic validation
    return !!(item.title && item.content && item.category)
  }

  // System instructions management
  getSystemInstructions(): string {
    return this.systemPrompt
  }

  updateSystemInstructions(newInstructions: string): boolean {
    try {
      // Validate that essential safety instructions are maintained
      if (newInstructions.includes("ูุง ุชุฐูุฑ ุฃุณุนุงุฑ ูุญุฏุฏุฉ") && newInstructions.includes("ูู ุตุงุฏูุงู")) {
        this.systemPrompt = newInstructions
        return true
      }
      return false
    } catch (error) {
      console.error("Error updating system instructions:", error)
      return false
    }
  }

  // Streaming response for real-time interaction
  async *streamResponse(messages: AIMessage[]) {
    try {
      const userMessage = messages[messages.length - 1]?.content || ""
      const relevantKnowledge = this.searchKnowledgeBase(userMessage)
      const intent = await this.analyzeUserIntent(userMessage)
      const enhancedSystemPrompt = this.buildEnhancedSystemPrompt(relevantKnowledge, intent)

      const result = await streamText({
        model: this.model,
        messages: [{ role: "system", content: enhancedSystemPrompt }, ...messages],
        maxTokens: 1000,
        temperature: 0.3,
      })

      for await (const delta of result.textStream) {
        yield delta
      }
    } catch (error) {
      console.error("Groq AI Streaming Error:", error)
      yield "ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ูู ุงูุงุชุตุงู. ูุฑุฌู ุงูุชูุงุตู ูุนูุง ูุจุงุดุฑุฉ ุนูู +963940632191"
    }
  }

  private buildEnhancedSystemPrompt(knowledge: KnowledgeItem[], intent: any): string {
    let knowledgeContext = ""

    if (knowledge.length > 0) {
      knowledgeContext = "\n\nูุนูููุงุช ูุคูุฏุฉ ูู ูุงุนุฏุฉ ุงููุนุฑูุฉ:\n"
      knowledge.forEach((item) => {
        knowledgeContext += `- ${item.title}: ${item.content}\n`
      })
    }

    return (
      this.systemPrompt +
      knowledgeContext +
      `

ุชุญููู ููุฉ ุงููุณุชุฎุฏู: ${intent.intent}
ูุณุชูู ุงูุซูุฉ: ${intent.confidence}

ุชุฐูุฑ: ุงุณุชุฎุฏู ููุท ุงููุนูููุงุช ุงููุคูุฏุฉ ุฃุนูุงู. ุฅุฐุง ูู ุชุฌุฏ ูุนูููุฉ ูุญุฏุฏุฉุ ุงุทูุจ ูู ุงูุนููู ุงูุชูุงุตู ุงููุจุงุดุฑ.`
    )
  }

  private searchKnowledgeBase(query: string): KnowledgeItem[] {
    const queryLower = query.toLowerCase()

    return this.knowledgeBase
      .filter((item) => {
        return (
          item.verified &&
          (item.title.toLowerCase().includes(queryLower) ||
            item.content.toLowerCase().includes(queryLower) ||
            item.category.toLowerCase().includes(queryLower))
        )
      })
      .slice(0, 3) // Limit to most relevant items
  }

  private calculateConfidence(response: string, knowledge: KnowledgeItem[]): number {
    // Higher confidence if response is based on verified knowledge
    if (knowledge.length > 0) {
      return 0.9
    }

    // Lower confidence for general responses
    if (response.includes("ููุญุตูู ุนูู ูุนูููุงุช ุฏูููุฉ") || response.includes("ูุฑุฌู ุงูุชูุงุตู ูุนูุง")) {
      return 0.8
    }

    return 0.6
  }

  private extractSources(knowledge: KnowledgeItem[]): string[] {
    return knowledge.map((item) => item.category)
  }

  private shouldRequireHumanFollowup(message: string, intent: any): boolean {
    const messageLower = message.toLowerCase()

    // Require human followup for pricing, complex technical questions, or complaints
    return (
      messageLower.includes("ุณุนุฑ") ||
      messageLower.includes("ุชูููุฉ") ||
      messageLower.includes("price") ||
      messageLower.includes("cost") ||
      messageLower.includes("ุดููู") ||
      messageLower.includes("ูุดููุฉ") ||
      intent.intent === "ุทูุจ_ุณุนุฑ" ||
      intent.intent === "ุดููู" ||
      intent.confidence < 0.6
    )
  }

  private generateSuggestedActions(intent: any, message: string): string[] {
    const actions: string[] = []

    if (intent.intent === "ุทูุจ_ุณุนุฑ" || message.toLowerCase().includes("ุณุนุฑ")) {
      actions.push("ุทูุจ ุนุฑุถ ุณุนุฑ ูุฎุตุต")
      actions.push("ุฌุฏููุฉ ููุงููุฉ ุงุณุชุดุงุฑูุฉ")
    }

    if (intent.intent === "ุงุณุชูุณุงุฑ_ุฎุฏูุงุช") {
      actions.push("ูุนุฑูุฉ ุงููุฒูุฏ ุนู ุงูุฎุฏูุงุช")
      actions.push("ุทูุจ ุนุฑุถ ุชูุถูุญู")
    }

    actions.push("ุงูุชูุงุตู ูุน ูุฑูู ุงููุจูุนุงุช")

    return actions
  }

  async analyzeUserIntent(message: string): Promise<{
    intent: string
    confidence: number
    entities: string[]
  }> {
    try {
      const { text } = await generateText({
        model: this.model,
        messages: [
          {
            role: "system",
            content: `ุญูู ุงูููุฉ ูู ุงูุฑุณุงูุฉ ุงูุชุงููุฉ ูุฃุฑุฌุน JSON ุจุงูุดูู ุงูุชุงูู:
{
  "intent": "ููุน ุงูููุฉ (ุงุณุชูุณุงุฑ_ุฎุฏูุงุชุ ุทูุจ_ุณุนุฑุ ุฏุนู_ุชูููุ ุดูููุ ุชุญูุฉุ ุฃุฎุฑู)",
  "confidence": ุฑูู ูู 0 ุฅูู 1,
  "entities": ["ุงูููุงูุงุช ุงููุณุชุฎุฑุฌุฉ ูู ุงููุต"]
}

ูู ุฏูููุงู ูู ุงูุชุญููู ููุง ุชุฎุชุฑุน ูุนูููุงุช.`,
          },
          {
            role: "user",
            content: message,
          },
        ],
        maxTokens: 200,
        temperature: 0.1, // Very low temperature for consistent analysis
      })

      try {
        const parsed = JSON.parse(text)
        return {
          intent: parsed.intent || "ุฃุฎุฑู",
          confidence: Math.min(Math.max(parsed.confidence || 0.5, 0), 1),
          entities: Array.isArray(parsed.entities) ? parsed.entities : [],
        }
      } catch {
        return {
          intent: "ุฃุฎุฑู",
          confidence: 0.3,
          entities: [],
        }
      }
    } catch (error) {
      console.error("Intent Analysis Error:", error)
      return {
        intent: "ุฃุฎุฑู",
        confidence: 0.1,
        entities: [],
      }
    }
  }
}

export const groqAI = new GroqAIService()
